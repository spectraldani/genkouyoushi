<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVG Grid Generator</title>
    <style>
        :root {
            --page-width: 297;
            --page-height: 210;
        }

        svg {
            height: auto;
            width: auto;
            max-width: 100%;
            max-height: 70vh;
            aspect-ratio: var(--page-width) / var(--page-height);
            border: 1px solid black;
            margin: 0 auto;
            display: block;
        }
    </style>
</head>

<body>
    <main>
        <form>
            <fieldset>
                <legend>Page</legend>
                <div class="input-group">
                    <label for="pageType">Page Type</label>
                    <select id="pageType" name="pageType">
                        <option value="215.9;279.4">Letter</option>
                        <option selected value="210;297">A4</option>
                        <option value="175.2;250">B5</option>
                        <option value="148;210">A5</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Margin (top right bottom left) (mm)</label>
                    <input type="number" id="marginTop" name="marginTop" value="20" step="1" min="0">
                    <input type="number" id="marginRight" name="marginRight" value="20" step="1" min="0">
                    <input type="number" id="marginBottom" name="marginBottom" value="20" step="1" min="0">
                    <input type="number" id="marginLeft" name="marginLeft" value="20" step="1" min="0">
                </div>
            </fieldset>
            <fieldset>
                <legend>Grid </legend>
                <div class="input-group">
                    <label for="innerSize">Inner Size (mm)</label>
                    <input type="number" id="innerSize" name="innerSize" value="8.0" step="0.1" min="0">
                    <label>Margin (top right bottom left) (%)</label>
                    <input type="number" id="boxMarginTop" name="boxMarginTop" value="0" step="0.1" min="0" max="1">
                    <input type="number" id="boxMarginRight" name="boxMarginRight" value="0.5" step="0.1" min="0"
                        max="1">
                    <input type="number" id="boxMarginBottom" name="boxMarginBottom" value="0" step="0.1" min="0"
                        max="1">
                    <input type="number" id="boxMarginLeft" name="boxMarginLeft" value="0" step="0.1" min="0" max="1">
                </div>
                <div class="input-group">
                    <label for="mainStrokeColor">Main stroke color</label>
                    <input type="color" id="mainStrokeColor" name="mainStrokeColor" value="#000000">
                    <label for="strokeWidth">Stroke Width (%)</label>
                    <input type="number" id="strokeWidth" name="strokeWidth" value="0.02" step="0.01" min="0" max="1">
                    <label for="gridStyle">Style</label>
                    <select id="gridStyle" name="gridStyle">
                        <option value="none">无</option>
                        <option value="grid" selected>方</option>
                        <option value="ruled">竖</option>
                    </select>
                    <label for="addCross">Cross:</label>
                    <input type="checkbox" id="addCross" name="addCross" checked>
                    <label for="addDiagonal">Diagonal:</label>
                    <input type="checkbox" id="addDiagonal" name="addDiagonal" checked>
                    <label for="addThirds">Thirds:</label>
                    <input type="checkbox" id="addThirds" name="addThirds">
                    <label for="addBox">Box:</label>
                    <input type="checkbox" id="addBox" name="addBox">
                </div>
                <div class="input-group">
                    <label for="titleColumnIdx">Add title column?</label>
                    <select id="titleColumnIdx" name="titleColumnIdx">
                        <option value="none" selected>None</option>
                        <option value="start">Start</option>
                        <option value="middle">Middle</option>
                        <option value="end">End</option>
                    </select>
                    <label for="titleHeight">Title length</label>
                    <input type="number" id="titleHeight" name="titleHeight" value="1" step="1" min="1" disabled>
                </div>
            </fieldset>
            <div class="code-output">
                <button type="button" class="copy-btn" id="copyBtn">Copy SVG</button>
                <button type="button" id="downloadBtn">Download SVG</button>
            </div>
        </form>
        <hr>
        <span>Cells: <span id="nCells"></span></span>
        <output class="preview-area" id="previewContainer">
            <!-- SVG will be injected here -->
        </output>
    </main>

    <script type="module">
        import { generatePage } from './svg.js';
        import { SpacingRectangle, Box } from './geometry.js';

        const titleColumnIdxInput = document.getElementById('titleColumnIdx');
        const titleHeightInput = document.getElementById('titleHeight');

        const previewContainer = document.getElementById('previewContainer');
        const copyBtn = document.getElementById('copyBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const nCells = document.getElementById('nCells');

        function update() {
            // Inputs
            const formState = Object.fromEntries(new FormData(document.forms[0]).entries());

            const [pageHeight, pageWidth] = formState.pageType.split(';').map(parseFloat);
            const innerSize = parseFloat(formState.innerSize);
            const boxMargin = new SpacingRectangle(
                innerSize * parseFloat(formState.boxMarginTop),
                innerSize * parseFloat(formState.boxMarginRight),
                innerSize * parseFloat(formState.boxMarginBottom),
                innerSize * parseFloat(formState.boxMarginLeft)
            );
            const strokeRelativeWidth = parseFloat(formState.strokeWidth);
            const boxSize = new Box(
                innerSize,
                innerSize,
                boxMargin,
                new SpacingRectangle(),
                innerSize * strokeRelativeWidth
            );

            const pageGeometry = new Box(
                pageWidth, pageHeight,
                new SpacingRectangle(),
                new SpacingRectangle(parseFloat(formState.marginTop), parseFloat(formState.marginRight), parseFloat(formState.marginBottom), parseFloat(formState.marginLeft))
            );

            const state = {
                boxSize,
                mainStrokeColor: formState.mainStrokeColor,
                boxStyle: formState.gridStyle,
                addCross: formState.addCross === 'on',
                addDiagonal: formState.addDiagonal === 'on',
                addThirds: formState.addThirds === 'on',
                addBox: formState.addBox === 'on',
                pageGeometry,
                titleColumn: formState.titleColumnIdx,
                titleLength: parseInt(formState.titleHeight),
            };

            const { svg: svgContent, nColumns, nRows } = generatePage(state);
            previewContainer.innerHTML = svgContent;
            nCells.textContent = `${nColumns} x ${nRows}`;
            titleHeightInput.max = nRows - 1;
            document.documentElement.style.setProperty("--page-width", pageWidth);
            document.documentElement.style.setProperty("--page-height", pageHeight);
            return svgContent;
        }

        titleColumnIdxInput.addEventListener('change', () => {
            titleHeightInput.disabled = titleColumnIdxInput.value === 'none';
        });

        document.querySelectorAll('form input, form select').forEach(input => {
            input.addEventListener('change', update);
        });

        copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(update());
            copyBtn.textContent = 'Copied!';
            setTimeout(() => copyBtn.textContent = 'Copy SVG', 2000);
        });

        downloadBtn.addEventListener('click', () => {
            const svgContent = update();
            const blob = new Blob([svgContent], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const temporaryLink = document.createElement('a');
            temporaryLink.href = url;
            temporaryLink.download = 'hanzi-grid.svg';
            temporaryLink.click();
            URL.revokeObjectURL(url);
            temporaryLink.remove();
        });

        update();
    </script>
</body>

</html>